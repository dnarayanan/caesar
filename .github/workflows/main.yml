name: CI

on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch
  push:
    branches:
      - citest
  pull_request:
    branches:
      - citest

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Init
        run: mkdir ~/datasets

      - name: Cache datasets
        uses: actions/cache@v1
        env:
          cache-name: cache-datasets
        with:
          path: ~/datasets
          key: ${{ env.cache-name }}

      - name: Download datasets
        run: |
          cd ~/datasets/
          curl -LO http://yt-project.org/data/gizmo_64.tar.gz
          tar xvf gizmo_64.tar.gz
          rm gizmo_64.tar.gz
          mv gizmo_64/output/snap_N64L16_000.hdf5 .
          mv gizmo_64/output/snap_N64L16_135.hdf5 .
          rm -r gizmo_64/output/*
          mv snap*.hdf5 gizmo_64/output/

      - name: Install caesar
        # update pip so we can install from git URLs
        # numpy and cython are required for yt because its setup.py is dumb
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install --user setuptools numpy cython
          cd /home/runner/work/caesar/caesar
          python3 -m pip install --user .

      - name: gizmo_64
        run: |
          cd /home/runner/work/caesar/caesar
          python3 scripts/commit_tests.py ~/datasets/gizmo_64/output/snap_N64L16_135.hdf5
